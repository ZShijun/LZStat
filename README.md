# LZStat

基于 `typecho` 的浏览量、点赞量统计插件。

## 插件特色

- 支持浏览量统计与显示
- 支持点赞量统计与显示
- 支持文章列表自定义排序
- 支持浏览量、点赞量异步接口调用
- 实现浏览量、点赞量当天不重复计算
- 支持点赞在当天取消
- 实现防抖策略，避免多次重复提交
- 实现榜单查询功能

## 插件安装

1. 下载 [LZStat](https://github.com/ZShijun/LZStat) ，解压到 `usr/plugins/` 目录下，将文件夹命名为 `LZStat`，确保`Plugin.php`文件直接在`LZStat`文件夹下；
2. 登录博客后台，进入`控制台`->`插件`，选择`LZStat`插件；
3. `启用`插件即可。

## 功能介绍

### 1. 浏览量统计与显示

插件启用之后，代码无需任何改动，也不需要配置，默认就可以实现对文章`浏览量`的统计，然后你就可以在你的页面中，通过如下代码显示统计结果了。

```php
<?php $this->viewsNum(); ?>
```

通常上述用法已经能够满足 `90%` 的使用场景，但如果你还有与下图所示类似的使用场景（点击页面元素，跳转到其它网址，但仍需要统计一次浏览量）。
![](https://cdn.jsdelivr.net/gh/ZShijun/image-repo/20240508/b99514952d65ca4e70806d7223ec8b45.png)

这时就必须在被点击的元素上加上`set-views`类和`data-cid`属性，示例代码如下：

```php
<a href="..." class="set-views" data-cid="<?php $this->cid() ?>">...</a>
```

其中，`set-views`是为了定位被点击的元素，而`data-cid`是为了找到对应的文章。

如果你还希望点击完成之后，浏览量在当前页面无刷新的更新，你就需要在显示浏览量的标签上加上`get-views`类和`data-cid`属性，示例代码如下：

```php
<span class="get-views" data-cid="<?php $this->cid(); ?>"><?php $this->viewsNum(); ?></span>
```

其中，`get-views`是为了定位显示浏览量的元素，而`data-cid`是为了找到对应的文章。

### 2. 点赞量统计与显示

点赞量统计与浏览量统计类似，只是没有默认统计一说，而是必须手动点击触发。因此，你必须在被点击的元素上，加上`set-likes`类和`data-cid`属性，示例代码如下：

```php
<i class="set-likes iconfont icon-zan" data-cid="<?php $this->cid(); ?>"></i>
```

然后，通过如下代码显示点赞量：

```php
<?php $this->viewsNum(); ?>
```

当然，如果你点错了或者后悔了，再次点击，就会取消点赞，即点赞数减一。

你也可以在自己的`css`文件中加入如下样式，以实现鼠标悬停的效果（因为每个人想要的效果可能不一样，所以该样式没有内置到插件中）。

```css
.set-likes:hover {
  cursor: pointer;
  color: #dc3545;
}
```

如果你希望`点赞`完成后，点赞量在当前页面无刷新的更新，则需要在显示点赞量的标签上加上`get-likes`类和`data-cid`属性，示例代码如下：

```php
<span class="get-likes" data-cid="<?php $this->cid(); ?>"><?php $this->likesNum(); ?></span>
```

### 3. 自定义排序

文章列表默认按照`创建时间`降序排序，但你可以通过修改插件的设置，实现按`创建时间`、`浏览量`、`点赞量`、`权重`(`点赞量 * 100 + 浏览量`)等更多形式的排序。例如，本文中提到的 [导航网站](https://nav.ilaozhu.com/) 就是按照`权重`排序的。

### 4. 榜单查询

你也可以手动根据`创建时间`、`浏览量`、`点赞量`、`权重`排序，查询前`N`条数据，主要用于侧边栏的`最新文章`、`热门文章`等功能，调用示例如下：

```php
<?php $rank = \TypechoPlugin\LZStat\Plugin::getRank(); ?>
<h3><?= $rank["title"]; ?></h3>
<?php if (empty($rank["posts"])) : ?>
    <div>暂无数据</div>
<?php else : ?>
    <div>
    <?php $posts = $rank["posts"];
    while ($posts->next()) : ?>
        <a href="<?php $posts->permalink() ?>"><?php $posts->title() ?></a>
    <?php endwhile; ?>
    </div>
<?php endif; ?>
```

查询类型可以通过插件设置，也可以通过参数传递，查询条数通过博客控制台的 **设置->阅读->文章列表数目** 指定。考虑到每个人想要的显示效果不同，该功能只提供了数据查询接口，界面渲染需要自己写代码实现。

## 统计接口

如果上述方式都不能满足你的需求，你也可以直接通过调用下面的接口实现统计功能，然后自行实现界面渲染。

| 接口名称   | 请求类型 | 接口地址                           | 返回值示例    |
| ---------- | -------- | ---------------------------------- | ------------- |
| 浏览量统计 | GET      | `/action/stat?do=views&cid=${cid}` | `{"total":0}` |
| 点赞量统计 | GET      | `/action/stat?do=likes&cid=${cid}` | `{"total":0}` |

## 适配主题

本插件目前已在以下主题中测试通过：

- [BeaconNav](https://github.com/ZShijun/BeaconNav)
- [WaterDrop](https://github.com/ZShijun/WaterDrop)

你可以转到主题源码，查看具体用法，后续还会尝试让其适配更多类型的主题，以实现更通用、易用的目的！

## 不足之处

由于本插件是基于`Cookie`实现的，因此，如果用户在浏览器中禁用了`Cookie`，则无法实现浏览量、点赞量不重复计算，取消点赞等功能；另外，更换浏览器或者手动删除`Cookie`，也都会导致数据统计不准确。

插件的复杂性和数据准确性，鱼和熊掌二者不可兼得，权衡利弊之后，我认为浏览量和点赞量的准确性相对而言不那么重要，因而依然选择了基于`Cookie`的实现方式，因此，在你使用本插件之前，也必须认可这一点才行。

## 总结

浏览量和点赞量统计几乎是所有类型的网站都需要的功能，网上也有很多的版本，但始终没有合我心意的。因此，我自己实现了这个插件，希望在满足自己需求的基础上，通过后续适配更多不同类型的主题，也能满足更多人的需求！
